{% extends 'finder/base.html' %}

{% block content %}

<div>
  <input type="text" id="search-input" placeholder="Search for restaurants by name, location, or cuisine" />
  <button id="search-button">Search</button>
</div>
<div id="map" style="height: 700px; width: 100%;"></div>
<ul id="restaurant-list"></ul>

<script>
  (g => {
    let h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
    b = b[c] || (b[c] = {});
    var d = b.maps || (b.maps = {}), r = new Set(), e = new URLSearchParams(), u = () => h || (h = new Promise(async (f, n) => {
      await (a = m.createElement("script"));
      e.set("libraries", [...r] + "");
      for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
      e.set("callback", c + ".maps." + q);
      a.src = `https://maps.${c}apis.com/maps/api/js?` + e;
      d[q] = f;
      a.onerror = () => h = n(Error(p + " could not load."));
      a.nonce = m.querySelector("script[nonce]")?.nonce || "";
      m.head.append(a);
    }));
    d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n));
  })({
    key: "YOUR_API_KEY", // Replace with your actual Google Maps API key
    v: "weekly",
  });

  async function initMap() {
    const [lat, lng] = '{{ location }}'.split(',');
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };

    const { Map } = await google.maps.importLibrary("maps");
    const { Marker } = await google.maps.importLibrary("marker");
    const map = new Map(document.getElementById('map'), {
      zoom: 12,
      center: center
    });

    const service = new google.maps.places.PlacesService(map);
    let markers = []; // Array to store markers
    const infoWindow = new google.maps.InfoWindow(); // Create an InfoWindow

    // Function to clear existing markers from the map
    const clearMarkers = () => {
      markers.forEach(marker => marker.setMap(null)); // Remove each marker from the map
      markers = []; // Clear the markers array
    };

    // Function to search for restaurants
    const searchRestaurants = (query) => {
      const request = {
        location: center,
        radius: '50000', // Search within 20 km
        type: ['restaurant'],
        keyword: query // Using keyword for searching
      };

      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          const listElement = document.getElementById('restaurant-list');
          listElement.innerHTML = ''; // Clear previous results
          clearMarkers(); // Clear existing markers before adding new ones

          results.forEach(restaurant => {
            const marker = new Marker({
              position: restaurant.geometry.location,
              map: map,
              title: restaurant.name
            });

            markers.push(marker); // Store the marker

            // Add click event to each marker to show InfoWindow with restaurant details
            google.maps.event.addListener(marker, 'click', () => {
              const contentString = `
                <div>
                  <h2>${restaurant.name}</h2>
                  <p>Rating: ${restaurant.rating || 'N/A'}</p>
                  <p>Address: ${restaurant.vicinity}</p>
                </div>`;
              infoWindow.setContent(contentString);
              infoWindow.open(map, marker);
            });

            const listItem = document.createElement('li');
            listItem.textContent = `${restaurant.name} - Rating: ${restaurant.rating || 'N/A'}`;
            listElement.appendChild(listItem);
          });
        } else {
          console.error('Error fetching restaurants: ', status);
        }
      });
    };

    // Event listener for search button
    document.getElementById('search-button').addEventListener('click', () => {
      const query = document.getElementById('search-input').value;
      searchRestaurants(query); // Call search function with the input value
    });
  }

  initMap();
</script>

{% endblock %}
