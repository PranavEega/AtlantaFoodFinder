{% extends 'finder/base.html' %}

{% block content %}

<div style="display: flex;">
  <!-- Filter Sidebar -->
  <div style="width: 300px; padding: 20px; border-right: 1px solid #ddd;">
    <h3>Filters</h3>

    <label for="rating-range">Rating: <span id="rating-display">0</span>+</label>
    <input type="range" id="rating-range" min="0" max="5" step="0.1" value="0">
    <br/>
    <label for="distance-range" style="margin-top: 20px;">Distance: <span id="distance-display">15</span> mi</label>
    <input type="range" id="distance-range" min="0.1" max="30" step="0.1" >

    <button id="apply-filters" style="margin-top: 20px;">Apply Filters</button>
  </div>

  <!-- Map and Search Area -->
  <div style="flex: 1; padding: 20px;">
    <div>
      <input type="text" id="search-input" placeholder="Search for restaurants by name, location, or cuisine" />
      <button id="search-button">Search</button>
    </div>
    <div id="map" style="height: 700px; width: 100%; margin-top: 20px;"></div>
    <ul id="restaurant-list"></ul>
  </div>
</div>

<script>
  let map;
  let service;
  let markers = [];
  let userLocation = { lat: 33.7490, lng: -84.3880 }; // Default to Atlanta
  let userLocationMarker;
  let activeInfoWindow = null;

  function loadGoogleMapsAPI() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDL_c5ZXIdrheexPbzzD3lPuYJGDZFVSTM&libraries=places&callback=initMap`;
    script.async = true;
    script.onerror = function() {
      alert('Failed to load Google Maps API. Please check your API key and network.');
    };
    document.head.appendChild(script);
  }

  function initMap() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          createMap(userLocation);
          displayUserLocationMarker(userLocation);
        },
        () => {
          createMap(userLocation);
          displayUserLocationMarker(userLocation);
        }
      );
    } else {
      createMap(userLocation);
      displayUserLocationMarker(userLocation);
    }
  }

  function createMap(center) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: center,
      zoom: 12
    });

    service = new google.maps.places.PlacesService(map);
  }

  function clearMarkers() {
    markers.forEach(marker => {
      if (marker !== userLocationMarker) {
        marker.setMap(null);
      }
    });
    markers = markers.filter(marker => marker === userLocationMarker);
  }

  function displayUserLocationMarker(location) {
    if (userLocationMarker) {
      userLocationMarker.setMap(null);
    }
    userLocationMarker = new google.maps.Marker({
      position: location,
      map: map,
      title: 'Your Location',
      icon: {
        url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
      }
    });
    markers.push(userLocationMarker);
    map.setCenter(location);
  }

  function searchRestaurants(query) {
    const request = {
      location: userLocation,
      radius: 50000, // 50 km
      type: 'restaurant',
      keyword: query
    };

    service.nearbySearch(request, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        applyFilters(results);
      } else {
        console.error('Error fetching restaurant data: ', status);
      }
    });
  }

  function applyFilters(results) {
    const minRating = parseFloat(document.getElementById('rating-range').value);
    const maxDistance = parseFloat(document.getElementById('distance-range').value);

    clearMarkers();
    const listElement = document.getElementById('restaurant-list');
    listElement.innerHTML = '';

    results.forEach(restaurant => {
      const rating = restaurant.rating || 0;
      const distance = calculateDistance(userLocation, restaurant.geometry.location);

      if (rating >= minRating && distance <= maxDistance) {
        const marker = new google.maps.Marker({
          position: restaurant.geometry.location,
          map: map,
          title: restaurant.name
        });

        markers.push(marker);

        // Event listener for marker click
        marker.addListener('click', () => {
          if (activeInfoWindow) {
            activeInfoWindow.close();
          }

          // Call getRestaurantDetails to fetch details
          getRestaurantDetails(restaurant.place_id, marker);
        });

        const listItem = document.createElement('li');
        listItem.textContent = `${restaurant.name} - Rating: ${rating} - Distance: ${distance.toFixed(2)} mi`;
        listElement.appendChild(listItem);
      }
    });
  }

  function getRestaurantDetails(placeId, marker) {
    const request = {
      placeId: placeId,
      fields: ['name', 'rating', 'formatted_phone_number', 'formatted_address', 'reviews']
    };

    service.getDetails(request, (place, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${marker.getPosition().lat()},${marker.getPosition().lng()}`;
        const contentString = `
          <div>
            <h2>${place.name}</h2>
            <p>Rating: ${place.rating}</p>
            <p>Address: ${place.formatted_address}</p>
            <p>Phone Number: ${place.formatted_phone_number}</p>
            <a href="${directionsUrl}" target="_blank">Get Directions</a>
            <h3>Reviews:</h3>
            <div style="max-height: 200px; overflow-y: auto;">
              ${place.reviews ? place.reviews.map(review => `
                <div style="margin-bottom: 10px;">
                  <p><strong>${review.author_name}</strong> - ${review.rating} stars</p>
                  <p>${review.text}</p>
                </div>
              `).join('') : 'No reviews available'}
            </div>
          </div>
          <div><button onclick="">Add Favorite Restaurant</button></div>`;

        const infoWindow = new google.maps.InfoWindow({
          content: contentString
        });
        infoWindow.open(map, marker);
      } else {
        console.error('Error fetching restaurant details: ', status);
      }
    });
  }

  function calculateDistance(point1, point2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (point2.lat() - point1.lat) * Math.PI / 180;
    const dLng = (point2.lng() - point1.lng) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat() * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c) / 1.6; // Distance in miles
  }

  document.getElementById('search-button').addEventListener('click', () => {
    const query = document.getElementById('search-input').value;
    searchRestaurants(query);
  });

  document.getElementById('apply-filters').addEventListener('click', () => {
    const query = document.getElementById('search-input').value;
    searchRestaurants(query);
  });

  // Update filter displays
  document.getElementById('rating-range').addEventListener('input', function() {
    document.getElementById('rating-display').textContent = this.value;
  });
  document.getElementById('distance-range').addEventListener('input', function() {
    document.getElementById('distance-display').textContent = this.value;
  });

  window.onload = loadGoogleMapsAPI;
</script>

{% endblock %}
